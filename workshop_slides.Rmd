---
title: "Bring your R Application Safely to Production."
subtitle: "Collaborate, Deploy, Automate."
author: "Riccardo Porreca, Peter Schmid <br/>(Francesca Vitalini)"
date: "e-Rum2020 Workshop<br/>2020-06-20 14:00-17:00 CEST"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["default", "styles.css"]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      slideNumberFormat: "%current%/%total%"
      ratio: 16:9
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(eval = FALSE)
with_excluded <- FALSE
```

layout: true

<div class="my-footer"><span>Copyright (c) 2020</span></div> 

---

![devCycle](./img/MiraiApr19_full.jpg)

- Interdisciplinary team of data scientists, software engineers and IT architects
- Specialist knowledge ranging from finance, risk management and actuarial knowledge to math / stats techniques
- 100+ years of cumulative professional experience in financial services / insurance, software engineering, and professional training

### Bringing ideas to life.
### Smart. Agile. Personal.

```{r eval = TRUE, echo = FALSE, out.width = "50%", out.extra='style="position:absolute;bottom:100px;right:50px;"'}
knitr::include_graphics("./img/mirai-solutions-logo-flyer.png")
```

---

## Mirai Solutions

- Involved in organizing e-Rum2020
- Eager contributors to open source projects

```{r eval = TRUE, echo = FALSE, out.width = "50%", out.extra='style="position:absolute;bottom:80px;right:100px;"'}
knitr::include_graphics("./img/sticker-pyramid.png")
```

---

## Your Miraiers for the day

.pull-left[
### Riccardo
- Senior Solutions Consultant
- Computer Science / Automatic Control Engineer by education
- Academia :: Matlab => Mirai :: R (and more)
- R enthusiast since then
- Analytics in enterprise environments
- Open source projects
]

.pull-right[
### Peter
- Solutions Consultant
- Environmental scientist by education
- Using R since many years,
  first for statistics, now lots more
- Analytics in enterprise environments
- Passionate about machine and deep learning
]

--

.center[
#### With VanLog's support: 
### Andrea Melloncelli
]


---

## Workshop overview

.pull-left[
- Working example: packaged Shiny app on GitHub
- Automated checks on Travis CI
- **Break**
- GitFlow, branch control and pull requests
- Agile approach and release
- Setup shinyapps.io for deployment
- **Break**
- GitHub Actions workflows
- Continuous Deployment
- More full-cycle playground 
]

--

.pull-right[

- (Meant to be) **loosely-coupled**

- **Hands-on**

  - First: Observe, learn, understand
  - Then: Do!

- Concepts and principles not tailored to Shiny apps and specific tools / services

]


---

## Workshop prerequisites

- A GitHub account is necessary for the workshop: also make sure you have its password at hand

- Git must be installed on your computer

- A recent version of RStudio (>= 1.2) is recommended

- R installation: R >= 3.6.x, ideally R 4.0.x

- Packages pre-installation: 
  - https://github.com/miraisolutions/eRum2020Workshop-prereqs#readme

- Optional Git-related tools

  - [compareWith](https://github.com/miraisolutions/compareWith#readme) R package
  - [Sublime Merge](https://www.sublimemerge.com)


---

## (Shiny) App development cycle

Target "Production": deployed and made accessible

.pull-right[
```{r eval = TRUE, echo = FALSE, out.width = "35%", out.extra='style="position:absolute;top:60px;right:50px;"'}
knitr::include_graphics("./img/devCycle.001.png")
```
]


- Development (app code)
- ...
- Deployed app (today: shinyapps.io)

Fill the dots:
- Safety checks and controls
- Collaboration and planning
- Automate!

### Head start: Morning workshop "_Is R ready for Production? Let’s develop a Professional Shiny Application!_"

---

## Head start: Packaged Shiny app on GitHub

Shiny app developed as **R package**

- Best place for R functions to live in => modularization
- Documentation, namespaces / dependencies, tests, sanity checks, controls, ...
- Package [`golem`](https://thinkr-open.github.io/golem) providing development framework<br/>
  `golem` : Shiny app = `devtools` : R package
- Package dependencies explicitly tracked using [`renv`](https://rstudio.github.io/renv)
- Run the app: install the package and call a function!

**Production readiness**

- How to ensure it is maintained, regularly checked and ensured?
- How to control what is deployed to "production" (the live app)?
- Automated, streamlined pipelines
   
   - Security, Quality, Stability  
   - Optimized for speed of delivery

---

## Version control - Git(Hub)

.pull-left[

- Git is a popular, free and open source version control system designed to be very efficient and to support distributed, non-linear workflows. 
- With GitHub remote hosting, it is the _de facto_ standard for open source (R) projects
- Track changes
- History
- Share and Collaborate
]

.pull-right[
- Pull ([`git pull`](https://git-scm.com/docs/git-pull)): Incorporate changes from a remote repository into the current local branch
- Stage ([`git add`](https://git-scm.com/docs/git-commit)) changes: Prepare the content for the next commit
- Commit ([`git commit`](https://git-scm.com/docs/git-commit)): Record staged changes to the current branch
- Push ([`git push`](https://git-scm.com/docs/git-push)): Update remote repository using the local branch
]

Resources

- [Git documentation](https://git-scm.com/doc)
- [Happy Git and GitHub for the useR](https://happygitwithr.com/), Jenny Bryan, Jim Hester
- [Git and GitHub](http://r-pkgs.had.co.nz/git.html), R packages, Hadley Wickham

---

## Running example

- (The app developed during the morning workshop)
- A somewhat **minimal example** of a Shiny app showcasing the same production-readiness approach

   - GitHub repo https://github.com/miraisolutions/ShinyCICD-min
   - Create your own copy of the repo by [forking](https://github.com/miraisolutions/ShinyCICD/fork) it to your GitHub user account.

**_Clone_** locally your forked repo (https://github.com/&lt;user&gt;/ShinyCICD-min) as a **new RStudio project**.

```
File > New Project... > Version Control > Git
```

---

## `renv` dependencies

The project is based on [`renv`](https://rstudio.github.io/renv)

- Project-specific dependencies are tracked via an `renv.lock` file (+ `.Rprofile` and `renv/`)
- Ensure the set of dependencies is collaboratively shared an maintained (and can be used to align production deployments)
- When you open the project (and a new R session starts), `renv` detects the project dependencies are out of sync
  ```{r}
  renv::status()
  renv::restore()
  ```

--

**Note**: if you are on R 3.6.x, you will see a warning `Project requested R version '4.0.z' but '3.6.x' is currently being used`. No big deal, simply align the R version in the lockfile via
```r
renv::snapshot()
```
What changes (check the Git pane)? Should you commit the modifications?

---

## Install the package, run the app!

RStudio's Build Pane

- Install and Restart (Ctrl+Shift+B)

Then, launching the app is just about calling a function from the package:

```{r}
shinyCICD::run_app()
```

Easy, isn't it?

- Dependencies under control (esp. with distributed users)
- No need to source the app code (once the package is installed, the source package code does not even matter!)

Speed up in a development workflow

- `devtools::load_all()` (Ctrl+Shift+L): mimics the full-install, but is much quicker

    - `install.packages("devtools")`

- `golem::document_and_reload()` includes a few extras (`help()`)

---

## R's package check suite

- `R CMD check` built into R, conveniently accessed via 
    - ```{r}
       devtools::check()
       ```
    - ```{r}
      rcmdcheck::rcmdcheck()
      ```
    - RStudio: `Build Pane` > `Check`

Everything should be fine. 

- If the check get stuck, it might be due to issues with `renv` (mainly on Windows).

- In case, fall-back on `renv`-free setup and still follow the rest of the workshop

    - `renv::deactivate()`
    - delete `renv.lock` and the `renv` folder.

---

## Automated checks on Travis (1)

Setup Travis CI to automate package-level checks for continuous integration, triggered upon any push event (and pull requests) on the GitHub repo.

- Login at https://travis-ci.com/ (using your GitHub account)
- Activate authorization via GitHub Apps integration.

.center[
```{r eval = TRUE, echo = FALSE, out.width = "450px", out.extra = 'style="position: relative;"'}
knitr::include_graphics("./img/TravisActivate.png")
```
```{r eval = TRUE, echo = FALSE, out.width = "250px", out.extra = 'style="position: relative;"'}
knitr::include_graphics("./img/TravisInstall.png")
```
```{r eval = TRUE, echo = FALSE, out.width = "250px", out.extra = 'style="position: relative;"'}
knitr::include_graphics("./img/TravisSetup.png")
```
]

---

## Automated checks on Travis (2)

- Setup Travis for your project 
  ```{r}
  usethis::use_travis() # ext = "com" for usethis < 1.6.0
  ```
- This will bring you to https://travis-ci.com/account/repositories, from where you can "Manage repositories on GitHub" to make sure Travis CI has access to your repo
- Look at the R console and the Git diffs (**don't commit changes yet**)

  - which files were changed by `usethis::use_travis()`? 

--

Travis has a default pipeline for R (https://docs.travis-ci.com/user/languages/r).

Align R _major_._minor_ version to the project setup (spaces matter!)
```yaml
r:
  - 4.0 # or 3.6
```
Use `renv` to restore dependencies:
- `cache` and `install` field as in the [Using renv with Continuous Integration](https://rstudio.github.io/renv/articles/ci.html#travis-ci) vignette.

---

## Automated checks on Travis (3)

```yml
language: R
r:
  - 4.0 # or 3.6
cache:
  directories:
  - $HOME/.local/share/renv
  - $TRAVIS_BUILD_DIR/renv/library
install:
  - Rscript -e "if (!requireNamespace('renv', quietly = TRUE)) install.packages('renv')"
  - Rscript -e "renv::restore()"

```

**Commit & push** all changes

- Go to the GitHub repo (`usethis::browse_github()`)
  - Do you find any indication of the CI status for the commit?
  
- This will trigger the first run on Travis, which can take >~10 minutes


---

class: inverse center middle
# Break

---

## Gitflow

.pull-left[
[Gitflow](https://nvie.com/posts/a-successful-git-branching-model/) is a standard setup that allows a collaborative development, while assuring the safety of the released product.

According to the Gitflow approach, the central repo holds two main branches with an infinite lifetime:

- `master`: reflects a production-ready state.
- `develop`: reflects a state with the latest delivered developments for the next release.

Each feature branch provides an additional incremental value to the product, potentially ready for deployment. ]

.pull-right[
```{r eval = TRUE, echo = FALSE, out.width = "90%", fig.cap='https://nvie.com/posts/a-successful-git-branching-model/'}
knitr::include_graphics("./img/gitflow.png")
```
]

---

## Issues, Projects and Pull Requests

New development items are usually recorded on GitHub as [Issues](https://help.github.com/en/github/managing-your-work-on-github/creating-an-issue).

Issues can be managed via visual boards by creating a [project](https://help.github.com/en/github/managing-your-work-on-github/about-project-boards) on GitHub.

The deveopment associated with each issue should, in principle, occurr in a separate `feature` [branch](https://help.github.com/en/github/collaborating-with-issues-and-pull-requests/creating-and-deleting-branches-within-your-repository), for the separation of concerns between different developments. 

Once the development is concluded it can be integrated back in the main development branch via [pull request](https://help.github.com/en/github/collaborating-with-issues-and-pull-requests/about-pull-requests).

LIVE: FIX ISSUR ON A BRANCH --> MAKE PULL REQUEST TO MERGE THIS INTO THE MAIN BRANCH

```{r eval = TRUE, echo = FALSE, out.width = "80%", out.extra='style="position:absolute;bottom:60px;right:50px;"'}
knitr::include_graphics("./img/project-board.png")
```

---

## Agile Development

Gitflow fits well with all Agile frameworks: at each development cycle a set of Issues is worked on according to prioritization. At the end of each development cycle it is possible to perform a release and have a development increment onto production. Each feature can be inspected and feedback can be given before its release, keeping the final product always up to date with the end user needs.

```{r eval = TRUE, echo = FALSE, out.width = "65%", out.extra='style="position:absolute;bottom:40px;right:50px;"'}
knitr::include_graphics("./img/agile_dev.001.png")
```

---

## Pull Requests and Branches Control

It is important that the code is checked before it is merged back into the main development to ensure robustness and stability of the code. This can be ensured by [setting restrictions on branches](https://help.github.com/en/github/administering-a-repository/enabling-branch-restrictions):

- [request a reviewer on each pull request](https://help.github.com/en/github/collaborating-with-issues-and-pull-requests/requesting-a-pull-request-review)
- [require an automatic status check](https://help.github.com/en/github/administering-a-repository/about-required-status-checks) (e.g. Travis CI) before merging to `master` or `develop`.

LIVE SHOW HOW TO SET BRENCHES CONTROLS
LIVE SHOW CHECKS PASSING BEFORE MERGING.

```{r eval = TRUE, echo = FALSE, out.width = "50%", out.extra='style="position:absolute;bottom:60px;right:50px;"'}
knitr::include_graphics("./img/branches-control.001.png")
```

---

## Deployment shinyapps.io

Our productive environment is going to be [shinyapps.io](https://www.shinyapps.io/), a platform to host Shiny apps and share them on the web. The service runs in the cloud on shared servers operated by RStudio.

[Setup a shinyapp.io account](https://docs.rstudio.com/shinyapps.io/getting-started.html#CreateAccount)

[Deployment of an application from RStudio](https://docs.rstudio.com/shinyapps.io/getting-started.html#deploying-a-sample-application)

LIVE: MANUAL DEPLOYMENT → CHECK ALL WORKS

```{r eval = TRUE, echo = FALSE, out.width = "80%", out.extra='style="position:absolute;bottom:100px;right:50px;"'}
knitr::include_graphics("./img/shinyappsio.png")
```

---

class: inverse center middle
# Break

---

## GitHub Actions

.inverse-left-column[
[GitHub Actions](https://help.github.com/en/actions) is a service for completely customizable, GitHub integrated workflow, including CI and CD executions.

[Workflows](https://help.github.com/en/actions/configuring-and-managing-workflows/configuring-a-workflow) use `YAML` syntax and should be stored in the `.github/workflows` directory in the root of the repository.
]

.inverse-right-column[
.pull-middle[
```{r eval = TRUE, echo = FALSE, out.width = "60%"}
knitr::include_graphics("./img/github-actions.png")
```
]
]

&nbsp;
&nbsp;
&nbsp;

Workflows are constituted of jobs and each job is a set of steps to perform individual tasks, e.g. commands or actions.

Compared to Travis CI, in GitHub Actions each step needs to be explicitly specified. Moreover, for the time being, GitHub Actions does not support a hierarchical, aggregated structure of actions.

---

## Generic CI/CD Pipeline

Generally speaking, a CI pipleline for an R package is comprised of the following steps:

- define system environment
- install R
- chaching system environment
- check out the package
- install package dependencies
- chaching dependencies
- install package
- run checks
- caching build
- deploy

---

## CI Workflow in GitHub Actions - check out the package

The workflow runs upon push commands and pull requests on the `master` branch, which is the default. It uses the predefined and built in action `checkout@v2` to check out the R package.

```yaml
# Check on push and pull requests to master
on: [push, pull_request]

# Name of the workflow
name: CI

jobs:
  CI:
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v2

      - uses: r-lib/actions/setup-r@master
```

---

## CI Workflow in GitHub Actions - manage dependencies

To install an R package we should first take care of its dependencies. This means checking them out and making sure they are cached for future builds.

```yaml
# Query and cache R package dependencies
- name: Query dependencies
  run: |
  install.packages("remotes")
  saveRDS(remotes::dev_package_deps(dependencies = TRUE), 
          "depends.Rds", version = 2)
  shell: Rscript {0}
- name: Cache R packages
  uses: actions/cache@v1
  with:
    path: ${{ env.R_LIBS_USER }}
    key: ${{ runner.os }}-r-${{ hashFiles('depends.Rds') }}
    restore-keys: ${{ runner.os }}-r-
```

---

## CI Workflow in GitHub Actions - install the package

Then the package can be installed

```yaml

- name: Install dependencies
  run: |
  remotes::install_deps(dependencies = TRUE)
  shell: Rscript {0}
```

---

## CI Workflow in GitHub Actions - run automatic checks

To run automatic checks it is necessary to explicitely request to run `rcmdcheck::rcmdcheck`, therefore we should make sure that the package is available.

```yaml
- name: Install rcmdcheck
  run: |
    remotes::install_cran(c("rcmdcheck"))
  shell: Rscript {0}

- name: Check package
  run: rcmdcheck::rcmdcheck(args = "--no-manual", 
                            error_on = "warning", check_dir = "check")
  shell: Rscript {0}
```


LIVE: LINK TO TECHGUIDES

---

## DevOps

.pull-left[
**Goals**
- Achieve faster time to production
- Enable more frequent deployments
- Lower failure rate of new releases
- Shorten lead time between fixes
- Enhance collaboration between groups
]

.pull-right[
**Challenges**
- Mindset and Culture
- Security
- Responsibility
]


```{r eval = TRUE, echo = FALSE, out.width = "50%", out.extra='style="position:absolute;bottom:50px;right:50px;"'}
knitr::include_graphics("./img/devops.001.png")
```

---

## DevOps - Benefits

- Development via small work items increases the speed of development and improves its quality.
- Slow, repetitive and human made actions are error-prone. Automation in testing and deployment increases the stability of the production process.
- Version controlled development ensures traceability and repeatability of the development.
- Collaboration and an agile approach are keys to a functional production pipeline.
- Building, testing and deploying discrete development components improve confidence in the final product.

<br>

.pull-middle[
**DevOps is a culture. Tools can enable it.**

<br>

.fontsize08[
Note:
Infrastructure can also follow a continuous delivery philosophy (Infrastructure as Code).
]

]

---

## Automatic Deployment

Part of DevOps is to streamline the deployment process. 
Adding the deployment is another step in a `CI-CD` job. 
Notice that deployment to [shinyapps.io](https://www.shinyapps.io/) requires the package `rsconnect`, so it is necessary to install it explicitely.

```yaml
      - name: Install dependencies
        run: |
          remotes::install_cran(c("rsconnect"))
        shell: Rscript {0}
        
      - name: Deploy to shinyapps.io
        if: github.ref == 'refs/heads/master'
        env:
          SHINYAPPS_ACCOUNT: ${{ secrets.SHINYAPPS_ACCOUNT }}
          SHINYAPPS_TOKEN: ${{ secrets.SHINYAPPS_TOKEN }}
          SHINYAPPS_SECRET: ${{ secrets.SHINYAPPS_SECRET }}
        run: |
          account_info <- lapply(paste0("SHINYAPPS_", 
                                c("ACCOUNT", "TOKEN", "SECRET")), 
                                Sys.getenv)
          do.call(rsconnect::setAccountInfo, account_info)
          rsconnect::deployApp(appName = "ShinyCICD")
        shell: Rscript {0}
```

---

## Tokens & Secrets

The variables `SHINYAPPS_ACCOUNT`, `SHINYAPPS_TOKEN` and `SHINYAPPS_SECRET` are tokens defined on [shinyapps.io](https://www.shinyapps.io/) and stored on GitHub Actions as [secrets](https://help.github.com/en/actions/configuring-and-managing-workflows/using-variables-and-secrets-in-a-workflow).

```{r eval = TRUE, echo = FALSE, out.width = "100%"}
knitr::include_graphics("./img/shinyapps.io.tokens.png")
```

---

## Automatic Deployment with Travis CI

Equivalently, automated deployment can be integrated on Travis CI. We leave this to you as an exercise.

You can have a look at our techguides for support.

<iframe src="https://mirai-solutions.ch/techguides/" width="100%" height="50%" frameBorder="0"></iframe>

---

## Release

A [Release](https://help.github.com/en/github/administering-a-repository/releasing-projects-on-github) is the deployment to production of a specific chunck of development. Each new release determines a new version (minor or major) of the software.

According to the Gitflow approach, no work should be pushed directly to `master`, which is updated as part of a release with a pull request from a stable `develop` branch or a `release` branch.

```{r eval = TRUE, echo = FALSE, out.width = "20%", out.extra='style="position:absolute;bottom:100px;right:70px;"'}
knitr::include_graphics("./img/release.001.png")
```

---

## How to Do a Release 1

- Create a release branch (e.g. `release/v2.0.0`) from `develop`.

- Consolidate the changelog (`NEWS.md` in R, see e.g. [recommendations](http://r-pkgs.had.co.nz/release.html#important-files) and [style guide](https://style.tidyverse.org/news.html#news-release)).

Example

```{r, eval=FALSE}
1.0.0 release preps
- Closes #XYZ Updated report.
```

- Update package version (NEWS.md and DESCRIPTION files in R).

- Create and merge a new pull request release/v2.0.0 →  master,  where the `closes XXX` are in the pull request comment.

---

## How to Do a Release 2

- Create a new release tag on master (on [GitHub Code > releases > Draft new release](https://github.com/miraisolutions/SmaRP/releases/new)).
  - Tag version: v1.0.1
  - Release title: packagename 1.0.1
  - Body: Paste as comment the list of changes in `NEWS.md`
  - Click on "Publish release"

- Create a new pull request and merge release/v2.0.0  →  develop

- Prepare for next version on develop (by changing the version NEWS.md and DESCRIPTION files).

---

## Conclusions

Our final product is a packaged shiny app ready for production, with automatic CI / CD pipelines in place.

REPLACE LINK TO FINAL PRODUCT

<iframe src="https://mirai-solutions.ch/techguides/" width="100%" height="50%" frameBorder="0"></iframe>

---

## Next Steps

Next Steps, technical info → close workshop

---

## Get in Touch


**Other Services by Mirai solutions:**

- Training customized to your business case - technical and agile topics
- Data Analytics & Software development: from your needs to a functional implementation
- Infrastructure design, managment and maintenace

**Get in touch:**
- LinkedIn https://www.linkedin.com/company/mirai-solutions-gmbh/
- email info@mirai-solutions.com
- website https://mirai-solutions.ch

```{r eval = TRUE, echo = FALSE, out.width = "40%", out.extra='style="position:absolute;bottom:80px;right:50px;"'}
knitr::include_graphics("./img/mirai-solutions-logo-flyer.png")
```

---

class: inverse center middle
# Thank you!
